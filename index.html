<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Tracker de Cruceros</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: #2c3e50;
            text-align: center;
        }

        h2 {
            font-size: 1.8rem;
            margin: 2rem 0 1rem 0;
            color: #34495e;
            border-bottom: 3px solid #3498db;
            padding-bottom: 0.5rem;
        }

        .loading {
            text-align: center;
            font-size: 1.2rem;
            color: #7f8c8d;
            margin: 2rem 0;
        }

        .error {
            background-color: #e74c3c;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 1rem;
        }

        th {
            background-color: #3498db;
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }

        td {
            padding: 0.8rem 1rem;
            border-bottom: 1px solid #ecf0f1;
            font-size: 0.9rem;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .separator {
            background-color: #2c3e50;
            height: 6px;
        }

        .price {
            font-weight: 600;
            color: #27ae60;
        }

        .no-price {
            color: #95a5a6;
            font-style: italic;
        }

        .refresh-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            margin: 1rem 0;
            transition: background-color 0.3s;
        }

        .refresh-button:hover {
            background-color: #2980b9;
        }

        .refresh-button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .stat-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            color: #7f8c8d;
            margin-top: 0.5rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            table {
                font-size: 0.8rem;
            }
            
            th, td {
                padding: 0.6rem 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1> Tracker de Cruceros</h1>
        
        <div class="stats" id="stats" style="display: none;">
            <div class="stat-card">
                <div class="stat-number" id="totalSnapshots">0</div>
                <div class="stat-label">Consultas realizadas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCruises">0</div>
                <div class="stat-label">Total cruceros</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="lastUpdate">-</div>
                <div class="stat-label">ltima actualizaci贸n</div>
            </div>
        </div>

        <button class="refresh-button" id="refreshBtn" onclick="loadData()">
             Actualizar datos
        </button>

        <div id="loading" class="loading">
            Cargando datos...
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="content" style="display: none;">
            <h2>Historial detallado</h2>
            <div id="tableContainer"></div>
        </div>
    </div>

    <script>
        let historyData = [];

        // Funci贸n para formatear fechas
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString("es-CO", {
                day: "numeric",
                month: "short",
                hour: "numeric",
                minute: "2-digit",
                hour12: true,
            });
        }

        // Funci贸n para parsear fechas de cruceros
        function parseCruiseDate(dateStr) {
            return parseInt(dateStr, 10);
        }

        // Funci贸n para cargar los datos
        async function loadData() {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const contentEl = document.getElementById('content');
            const refreshBtn = document.getElementById('refreshBtn');
            const statsEl = document.getElementById('stats');

            try {
                loadingEl.style.display = 'block';
                errorEl.style.display = 'none';
                contentEl.style.display = 'none';
                statsEl.style.display = 'none';
                refreshBtn.disabled = true;

                const response = await fetch('./public/historial.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                historyData = await response.json();
                
                if (historyData.length === 0) {
                    throw new Error('No hay datos disponibles');
                }

                displayStats(historyData);
                displayTable(historyData);
                
                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';
                statsEl.style.display = 'grid';
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                errorEl.textContent = `Error cargando datos: ${error.message}`;
            } finally {
                refreshBtn.disabled = false;
            }
        }

        // Funci贸n para mostrar estad铆sticas
        function displayStats(history) {
            const totalSnapshots = history.length;
            const totalCruises = history.reduce((total, snapshot) => total + snapshot.cruises.length, 0);
            const lastUpdate = history.length > 0 ? formatDate(history[history.length - 1].date) : '-';

            document.getElementById('totalSnapshots').textContent = totalSnapshots;
            document.getElementById('totalCruises').textContent = totalCruises;
            document.getElementById('lastUpdate').textContent = lastUpdate;
        }

        // Funci贸n para mostrar la tabla
        function displayTable(history) {
            const chartData = [];
            
            // Procesar los datos como en el React original
            history.forEach((snapshot) => {
                const snapshotDate = snapshot.date;
                snapshot.cruises.forEach((cruise) => {
                    const { fecha, puertos } = cruise.text;
                    const { prices } = cruise;

                    chartData.push({
                        snapshotDate: formatDate(snapshotDate),
                        cruiseDate: fecha,
                        puertos,
                        Suite: prices.Suite,
                        Balcon: prices.Balcon,
                        "Vista al oceano": prices["Vista al oceano"],
                        Interno: prices.Interno,
                    });
                });
            });

            // Ordenar como en el React original
            const sorted = chartData.sort((a, b) => {
                const cruiseA = parseCruiseDate(a.cruiseDate);
                const cruiseB = parseCruiseDate(b.cruiseDate);

                if (cruiseA !== cruiseB) {
                    return cruiseA - cruiseB;
                }

                const snapA = new Date(a.snapshotDate);
                const snapB = new Date(b.snapshotDate);
                return snapB - snapA;
            });

            // Crear la tabla HTML
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Fecha de consulta</th>
                            <th>Fecha Crucero</th>
                            <th>Puertos</th>
                            <th>Suite</th>
                            <th>Balcon</th>
                            <th>Vista al oceano</th>
                            <th>Interno</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sorted.forEach((row, i) => {
                const priceClass = (price) => price ? 'price' : 'no-price';
                const priceDisplay = (price) => price ? price : '-';
                
                tableHTML += `
                    <tr>
                        <td style="white-space: nowrap;">${row.snapshotDate}</td>
                        <td>${row.cruiseDate}</td>
                        <td>${row.puertos}</td>
                        <td class="${priceClass}">${priceDisplay(row.Suite)}</td>
                        <td class="${priceClass}">${priceDisplay(row.Balcon)}</td>
                        <td class="${priceClass}">${priceDisplay(row["Vista al oceano"])}</td>
                        <td class="${priceClass}">${priceDisplay(row.Interno)}</td>
                    </tr>
                `;

                // Agregar separador si la siguiente fecha es diferente
                if (row.cruiseDate !== sorted[i + 1]?.cruiseDate) {
                    tableHTML += `
                        <tr>
                            <td colspan="7" class="separator"></td>
                        </tr>
                    `;
                }
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            document.getElementById('tableContainer').innerHTML = tableHTML;
        }

        // Cargar datos al iniciar la p谩gina
        document.addEventListener('DOMContentLoaded', loadData);

        // Auto-refresh cada 5 minutos (opcional)
        setInterval(loadData, 5 * 60 * 1000);
    </script>
</body>
</html>
